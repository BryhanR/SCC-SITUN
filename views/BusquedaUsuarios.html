<!DOCTYPE html>
<html ng-app = "app">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Busqueda de Usuarios</title>
   
  	<script src="\..\javascripts\new\jquery-1.12.2.js"></script>
	<script src="\..\javascripts\new\moment-2.15.1.js"></script>
	<script src="\..\javascripts\new\bootstrap-3-3-7.min.js"></script>
	<link rel="stylesheet" href="\..\javascripts\new\bootstrap-3-3-7.min.css">
	<script src="\..\javascripts\new\bootstrap-datetimepicker-4.7.14.js"></script>
	<script src="\..\javascripts\angular.min.js"></script>
	<link rel="stylesheet" href="\..\javascripts\new\bootstrap-datetimepicker-4.7.14.css">
    <body ng-app ng-controller = "ControllerAngular">

    <div id="menuDiv"></div>
   

	<!-- Trigger the modal with a button -->
<!-- Modal -->
<div class="col-md-1"></div>
	   
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">
   
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="text-danger">Edición</h4>
      </div>
      <div class="modal-body">
		<center><table  id ="tablaAU">
                <tbody>
				<tr>
                    <td><label class="text-danger">Identificación</label></td>
					<td><div id="div0" class="form-group"><input id="IU0" type="text" class="form-control" disabled ></input></div></td>
				</tr>
				
				<tr>
                    <td><label class="text-danger">Nombre</label></td>
					<td><div id="div1" class="form-group"><textarea id="IU1" type="text" class="form-control" onfocus="cambioClase1(1)"  ></textarea></div></td>
				</tr>
				
				<tr>
                    <td> <label class="text-danger">Primer Apellido</label> </td>	
					<td><div id="div2" class="form-group"><textarea id="IU2" type="text" class="form-control" onfocus="cambioClase1(2)"></textarea></div></td>				 
				</tr>
				
                <tr>
                    <td> <label class="text-danger">Segundo Apellido</label> </td>
                   <td><div id="div3" class="form-group"><textarea id="IU3" type="text" class="form-control" onfocus="cambioClase1(3)"></textarea></div></td> 
                </tr>
				
                <tr>
				    <td><label class="text-danger" for="exampleInputPassword1" >Contraseña</label> </td> 
                    <td><div id="div4" class="form-group"><input type="password" class="form-control" id="IU4" onfocus="cambioClase1(4)" disabled></input></div> </td>  
					<td><button id="btnCambiar" type="button" class="btn btn-default"  onclick = "activar()" style= "margin-left:10px; margin-bottom:10px">Cambiar</button></td>
                </tr>
				
				<tr>
				    <td><label class="text-danger" for="exampleInputPassword1" style="display:none" id="LIU5">Confirmar Contraseña</label> </td> 
                    <td><div id="div5" class="form-group"><input type="password" class="form-control" id="IU5" style="display:none" onfocus="cambioClase1(5)"></input></div> </td>  
					
			   </tr>
				
				<tr>
                    <td> <label class="text-danger">Administrador </label></td>
					<td> <label class="text-danger" style=""><input  type="checkbox" id="administrador_checkbox" value="enlace_checkbox"></label></td>
                </tr>

				</tbody> 
	     </table>  </center>
		 
		
		
      </div>
      <div class="modal-footer">
	    <center><button type="button" class="btn btn-default" ng-click = "actualiza()">Guardar</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button></center>	
      </div>
    </div>

  </div>
  </div>
</div>

<!---nuevo eliminacion-->
<!-- CUADRO DE ELIMINACION -->

<!-- Modal -->

<div class="col-md-1"></div>
	   
<div id="myModal2" class="modal fade" role="dialog">
  <div class="modal-dialog">
   
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="text-danger">Eliminacion de Usuarios</h4>
      </div>
      <div class="modal-body">
		<center><table  id ="tablaAU">
                <tbody>
				<tr>
                    <td><label  class="text-danger">¿Desea eliminar al usuario </label>
					<label id="labelEliminar" class="text-danger"></label>
					<label id="labelEliminar2" class="text-danger"></label>
					<label id="labelEliminar3" class="text-danger"></label>
					<label id="labelEliminar4" class="text-danger"></label>
					</td>
					
					</tr>
				
				
				</tbody> 
	     </table>  </center>
		 
		
		
      </div>
      <div class="modal-footer">
	    <center><button type="button" class="btn btn-default" ng-click = "eliminarUsuarios(c)">Si</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">No</button></center>	
      </div>
    </div>

  </div>
  </div>
</div>

<!--cierra eliminacion-->

	   <!---Cuerpo--->
	   <body background="../../../../images/situn4.png">
	   

	
	
	   <div class="col-md-8" style="margin-left:20px">
         <span class="text-danger"><h2>Tipo de Busqueda</h2></span>
 
           <form class="navbar-form navbar-left">         
        
            <div   class="form-group ">
				<select class="form-control" id="opBusqueda" ng-model = "criterio">
					<option value="identificacion">Identificación     
                    <option value="nombre">Nombre					
					<option value="apellido1">Primer apellido                                         
					<option value="apellido2">Segundo apellido                                     
				</select> 
               
          
				<input type="text" class="form-control" id="buscar"  ng-keyup= "($event.which == 13)?buscar():0">
				<input type = "button" class="btn btn-default" id="buscar" value = "Buscar" ng-click="buscar()" >
				<input type = "button"class="btn btn-default" id ="cancelar" value = "Cancelar"  ng-click="clear()" >
            
			</div>
         <p align="left"><p align="left">
		 <div class="table table-bordered" >
	    <p align="left"><table class="table" id="tabla_busqueda">

		<thead> 
			<tr class="danger">
			<td>Identicación</td>
			<td>Nombre</td>
			<td>Primer apellido</td>
			<td>Segundo apellido</td>
			<td>Edición</td> 
			<td>Eliminar</td> <!--// VER -->
			</tr>
		</thead>
		<tbody>
			<tr ng-repeat = "c in usuarios">
					<td> {{c.tp_4 }} </td>
					<td> {{c.tp_1 }} </td>
					<td> {{c.tp_2 }} </td>
					<td> {{c.tp_3 }} </td>
					<td> 
						<button   type="button" class="btn btn-danger" data-toggle="modal" data-target="#myModal" ng-click="obtenerUsuario(c)">Editar</button>
					</td>
					<td> 
						<button type="button" id="btnEliminar" class="btn btn-danger" data-toggle="modal" data-target="#myModal2" ng-click="obtenerUsuarios(c)" ng-disabled = "esDisabled(c.tp_4)"><img src="../../../../images/eliminar.png" width="20" height="20" /></button>
					</td>
			</tr>
		</tbody>       
	</table>
               </div></p>
      </form>
           
   
	   </div>
	
<script type="text/javascript">
  

$(document).ready(function() {
    // Solicita la informacion de la sesion si aun no existe en el storage
	$("#menuDiv").load("/HTML/menu");


});

let app = angular.module('app', []);

function controllerAngular($scope)//ControllerAngular
 {
	$scope.criterio = "identificacion";
	$scope.usuarios = new Array();
	$scope.updateUsuarios = c => $scope.usuarios = c;
	$scope.buscar = _ => busquedaUsuario($scope);
	$scope.clear = _ => limpiaDivMensaje($scope);
	$scope.obtenerUsuario	= n => asignarUsuario($scope, n);
    $scope.obtenerUsuarios	= s => asignarUsuario2($scope, s);	
	$scope.eliminarUsuarios	= e => eliminarUsuarios($scope, e); 
	$scope.actualiza =_ => actualizarInfo($scope);
	$scope.usuario = JSON.parse(localStorage.getItem('usuario'));
	$scope.esDisabled = id => id ===$scope.usuario.Id;//id.localeCompare($scope.usuario.Id) === 0;

  }
  
   app.controller('ControllerAngular', controllerAngular); 
   
  function actualizarInfo($scope){ //Actualiza la informacion en la base de datos
  console.log('validacion '+validar());
    if(validar()){
	console.log('Entro despues de validacion'+validar()); // Quitar
	actualizarPersona();
	actualizarUsuario();
    busquedaUsuario($scope);
	$('#myModal').modal('hide'); 
	}
  }
  
  function actualizarPersona(){ //actualiza la infromación del usuario en la tabla personas
    let a = $('#IU0').val().toUpperCase();
	let b = $('#IU1').val().toUpperCase();
	let c = $('#IU2').val().toUpperCase(); 
	let d = $('#IU3').val().toUpperCase(); 
 
   fetch( 'http://localhost:3000/api/TP/UD', {  
    method: 'POST', 
    datatype:'json',
    headers: {  
      "Content-type": "application/x-www-form-urlencoded"  
      } ,
    body: "TP_1="+ b+ "&TP_2="+c+
	"&TP_3="+ d + "&TP_4="+ a 
      }
	  )
  .then(function(response) {
		return response.text().then(function(res) {
				console.log("Resultado: "+res);
					if(res.indexOf("error")==-1){
						$("#mensaje").text("Acción realizada con exito");
			}
				});
	})
  .catch(function(error) {  
   console.log('Request failed', error);  
  });
  }
  
  
  function actualizarUsuario(){ //actualiza la informaciòn del usuario
    let a = $('#IU0').val();
	let b = $('#IU4').val();
	
	let c = 0;
	if($("#administrador_checkbox").prop("checked"))
		c = 1;
		
		
    fetch( 'http://localhost:3000/api/TU/UD', {  
    method: 'POST', 
    datatype:'json',
    headers: {  
      "Content-type": "application/x-www-form-urlencoded"  
      } ,
    body: "TU_1="+ a+ "&TU_2="+b+
	"&TU_3="+ c
      }
	  )
  .then(function(response) {
		return response.text().then(function(res) {
				console.log("Resultado: "+res);
					if(res.indexOf("error")==-1){
						$("#mensaje").text("Acción realizada con exito");
			}
				});
	})
  .catch(function(error) {  
   console.log('Request failed', error);  
  });
 
  }
  function validar(){ //Valiad los campos de entrada
	I2 = true;
	I3 = true;
	I4 = true;
	I5 = true;
	I6= true;

	if($("#IU1").val().length == 0){
		$("#div1").attr('class','form-group has-error') ;
		$("#IU1").attr('title','Campo Obligatorio') ;
		I2 = false;
	}
	else{
	  cambioClase1(1);
	$("#IU1").attr('title','');
	}
	if($("#IU2").val().length == 0){
		$("#div2").attr('class','form-group has-error') ;
		$("#IU2").attr('title','Campo Obligatorio') ;
		I3 = false;
	}
	else{
	 cambioClase1(2);
	$("#IU2").attr('title','');
	}
	if($("#IU3").val().length == 0){
		$("#div3").attr('class','form-group has-error') ;
		$("#IU3").attr('title','Campo Obligatorio') ;
		I4 = false;
	}
	else{
	 cambioClase1(3);
	$("#IU3").attr('title','');
	}
	if($("#IU4").val().length == 0){
		$("#div4").attr('class','form-group has-error') ;
		$("#IU4").attr('title','Campo Obligatorio') ;
		I5 = false;
	}
	else{
	 cambioClase1(4);
	$("#IU4").attr('title','');
	}
	if($( "#IU4" ).prop("disabled")!=true){ 
	if($("#IU5").val().length == 0){
		$("#div5").attr('class','form-group has-error') ;
		$("#IU5").attr('title','Campo Obligatorio') ;
		I6 = false;
	}
	else{
	 cambioClase1(5);
	$("#IU5").attr('title','');
	}
	}
	if($("#IU4").val()!=$("#IU5").val() && $( "#IU4" ).prop("disabled")!=true){
		$("#div4").attr('class','form-group has-error') ;
		$("#IU4").attr('title','La contraseña no coincide') ;
		$("#div5").attr('class','form-group has-error') ;
		$("#IU5").attr('title','La contraseña no coincide') ;
		$("#IU5").val("");
		$("#IU4").val("");
		I6 = false;
	}
	else{
	if(I6&&I5){
	 cambioClase1(4);
	$("#IU4").attr('title','');
	 cambioClase1(5);
	$("#IU5").attr('title','');
	}
	}

		return (I2  && I3  && I4 && I5 && I6 );	
}


function limpiarValores(){ //Limpia los valores de los campos de entrada
    $("#div5").attr('class','form-group') ;
	$("#IU5").attr('title','');
	$("#IU5").val("");
	let i =1;
	for(i=1;i<6;i++){
	   cambioClase1(i);
	}
}
  
  function cambioClase1(op){ //Realiza el cambio de clase de has-error a form-group
	switch(op){
		case 1:  $("#div1").attr('class','form-group'); break;
		case 2:	 $("#div2").attr('class','form-group'); break;
		case 3:  $("#div3").attr('class','form-group'); break;
		case 4:  $("#div4").attr('class','form-group'); break;
		case 5:  $("#div5").attr('class','form-group'); break;
	}
  }
  
  function activar(){
    $("#IU4").removeAttr("disabled");
    $("#LIU5").show();
    $("#IU5").show();	
    $("#btnCambiar").hide();
  }
  
  function desactivar(){
    $("#IU4").attr('disabled','disabled');
    $("#LIU5").hide();
    $("#IU5").hide();
	$("#btnCambiar").show();
  }
 
 function asignarUsuario($scope, cor)
 {	desactivar();
   limpiarValores();
   console.log("entran  asigna");
	 fetch( 'http://localhost:3000/api/TPTU/B', {  
    method: 'POST', 
    datatype:'json',
    headers: {  
      "Content-type": "application/x-www-form-urlencoded"  
      } ,
    body: "TU_1=" + cor.tp_4
      }
	)	 
	.then(res => res.json())
	.then(obj => cargarDatos(obj.data[0])
			)
	.catch(err => console.log('Request failed', err));
 }
 
  function asignarUsuario2($scope, cor)
 {	
 $("#labelEliminar").text(cor.tp_4+" ");
 $("#labelEliminar2").text(cor.tp_1+" ");
 $("#labelEliminar3").text(cor.tp_2+" ");
 $("#labelEliminar4").text(cor.tp_3+"?");
 }
  function cargarDatos(data){
  console.log(data);
     $("#IU1").val(data.tp_1);
     $("#IU2").val(data.tp_2);
     $("#IU3").val(data.tp_3);
	 $("#IU0").val(data.tu_1);
	 $("#IU4").val(data.tu_2);
	 if(data.tu_3 == 1)
		$("#administrador_checkbox").prop("checked", "checked");
	 
	 else
		$("#administrador_checkbox").prop("checked", "");

 }
 
 function busquedaUsuario($scope)  //Metodo de Busqueda
 {
 console.log("Retornado de url > " + tipoBusqueda($scope));
	let h3 = document.getElementById('buscar').value;
	
	 fetch( 'http://localhost:3000/api/TP/'+tipoBusqueda($scope), {  
    method: 'POST', 
    datatype:'json',
    headers: {  
      "Content-type": "application/x-www-form-urlencoded"  
      } ,
    body: tipoBusquedaBD($scope) + "=" + h3
      }
	)	 
	.then(res => res.json())
	.then(obj => $scope.$apply( _=>
					$scope.updateUsuarios(obj.data)))
	.catch(err => console.log('Request failed', err));
}
 
 
function tipoBusqueda($scope)// Toma el tipo de busqueda y regresa el sufijo correspondiente a la dirección del servidor
{
	let op = $scope.criterio;
	console.log("El tipo de busqueda es por: |" + op + "|");
	switch(op)
	{
		case 'identificacion': // Identicacion
			return 'B';
		case 'nombre': // Nombre
			return 'BN';
		case 'apellido1': // Primer apellido
			return 'BA1';
		case 'apellido2': // Segundo Apellido
			return 'BA2';
	}
}  
function tipoBusquedaBD($scope) //Toma el criterio de busqueda y devuelve la columna que se debe buscar en la BD
{
	let op = $scope.criterio;
	switch(op)
	{
		case 'identificacion': // Identicacion
			return 'TP_4';
		case 'nombre': // Nombre
			return 'TP_1';
		case 'apellido1': // Primer Apellido
			return 'TP_2';
		case 'apellido2': // Segundo Apellido
			return 'TP_3';
	}
	
} 

function limpiaDivMensaje($scope){// limpia el div con el id de buscar
	document.getElementById('buscar').value="";
	$scope.usuarios = new Array();
	} 
	
	
	
 function eliminarUsuarios($scope, cor) { //Elimina los usuarios de la base de datos
 
 eliminaTU($scope,cor);
 eliminaTP($scope,cor);
 busquedaUsuario($scope);
 busquedaUsuario($scope); 
 busquedaUsuario($scope);
 $('#myModal2').modal('hide'); // NUEVO
 }
 
 	function eliminaTU($scope, cor){
	let d = $("#labelEliminar").text();//$('#IU4').val();
	console.log("valor de D "+d);
	return fetch('http://localhost:3000/api/TU/D?TU_1=' + d, {  
     method: 'get', 
     mode:'no-cors',
     datatype:'html',
     headers: {  
      "Content-type": "text/html"
    }  
  })
		 .then(res => res.json())
     	 .then(json => (console.log(json),$scope.buscar()))		//.then(obj =>console.log("Objeto",obj))  //Columna especifica obj.data[0].tp_1 // Nota: para pasar a JSON se usa JSON.stringify(obj.data[0].tp_1)

		.catch(err => console.log('Request failed', err));
	}
	
		function eliminaTP($scope, cor){
	let d = $("#labelEliminar").text();//$('#IU4').val();
	console.log(d);
	return fetch('http://localhost:3000/api/TP/D?TP_4=' + d, {  
     method: 'get', 
     mode:'no-cors',
     datatype:'html',
     headers: {  
      "Content-type": "text/html"
    }  
  })
		 .then(res => res.json())
     	 .then(json => console.log(json))
		.catch(err => console.log('Request failed', err));
	}
	

	
</script>

  
    </body>
</html>