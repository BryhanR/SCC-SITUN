<!DOCTYPE html>
<html ng-app = "app">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Reportes</title>
  
  <script src="\..\javascripts\new\jquery-1.12.2.js"></script>
<script src="\..\javascripts\new\moment-2.15.1.js"></script>

<script src="\..\javascripts\new\bootstrap-3-3-7.min.js"></script>

<link rel="stylesheet" href="\..\javascripts\new\bootstrap-3-3-7.min.css">


<script src="\..\javascripts\new\bootstrap-datetimepicker-4.7.14.js"></script>

<link rel="stylesheet" href="\..\javascripts\new\bootstrap-datetimepicker-4.7.14.css">
	<!-- Angular--> 
	<script src="\..\javascripts\angular.min.js"></script>

  
	
	
    </head>
	
	
	
    <body ng-app ng-controller = "ControllerAngular">

    <div id="menuDiv"></div>

    <!--
    <nav class="navbar navbar-default" style="background-color:#60161E;">
    <div class="container-fluid">
    <!-- REsponsive ->
    <div class="navbar-header" >
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
  <IMG SRC="../images/situn2.png" WIDTH=85 HEIGHT=58  class="nav navbar-nav navbar-right">
    </div>

    <!-- Menu ->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav" style="margin-top:7px;">
        <li ><a href="../HTML/Ingreso de Correspondencia"style="color:#FFFFFF;"><b>Ingreso Correspondencia</b> </a></li>
        <li><a href="../HTML/Enlace de Documentos"style="color:#FFFFFF;"><b>Enlace Documentos</b></a></li>
        <li><a href="#"style="color:#FFFFFF;"><b>Búsqueda</b></a></li>
		<li><a href="#"style="color:#FFFFFF;"><b>Reportes</b></a></li>
		<!---li><a href="#"style="color:#FFFFFF;">Escanear</a></li->
			<li><a href="../HTML/ingresaUser"style="color:#FFFFFF;"><b>Agregar Usuario</b></a></li>
		<li><a href="../HTML/BusquedaUsuarios"style="color:#FFFFFF;"><b>Buscar Usuarios</b></a></li>
		 <li><a href="../logout"style="color:#FFFFFF;"><b>Cerrar sesion</b></a></li>
	    <li><a href="#" style="color:#FFFFFF;"><b>Ayuda</b></a></li>
      </ul>
    
        <IMG SRC="../images/situn2.png" WIDTH=85 HEIGHT=58  class="nav navbar-nav navbar-right">
    </div><!-- /.navbar-collapse ->
  </div><!-- /.container-fluid ->
</nav>
	  -->


	  <!-- Trigger the modal with a button -->
<!-- Modal -->

<div id="myAyuda" class="modal fade" role="dialog" style="margin: 0 auto; width:675px; height:500px;">
  <div class="well">
   
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="text-danger">Ayuda</h4>
      </div>
      <div class="modal-body">
		<right>
                <tbody>
				 Generar Reportes:<p>
					Para generar  reportes de correspondencia lo primero que debe hacer
					es seleccionar el rango de fechas de recibido del cual desea generar el
					reporte, para realizar esto debe selecionar las fechas en los calendarios que
					se encuentran junto a las etiquetas "Desde" y "Hasta" respectivamente, luego 
					debe dar click en el botón buscar, seguidamente aparecerá una lista en el cuadro 
					que se muestra en la página con los reportes de correspondencia que se ubican 
					en el rango de fechas que fue seleccionado.Finalmente debe dar click en el enlace 
					"Generar reporte de correspondencia" junto a el botón Cancelar.<p>
				</tbody> 
	       </right>
		
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button></center>	
      </div>
    </div>

  </div>
  </div>  <!-- fin del popup de ayuda --> 


	   <!---Cuerpo-->
	   <body background="../images/situn4.png">
	   

	
	
	   <div class="col-md-8" style="margin-left:20px" >
         
 
           <form class="navbar-form navbar-left">         
        
            <div   class="form-group ">
			
                  <span class="text-danger"><h2>Reportes  de Correspondencia </h2></span>
				  
				  
				   <label class="text-danger">Desde &nbsp; </label>
				  <div class='input-group date' id='datetimepicker1'>
          					<input type='text' class="form-control" id="f1"/>
          					<span class="input-group-addon" id="c1"  >
            					<span class="glyphicon glyphicon-calendar" ></span>
          					</span>
        				</div>
			          
					 <label class="text-danger">Hasta &nbsp; </label>
                     <div class='input-group date' id='datetimepicker2'>
          					<input type='text' class="form-control" id="f2"/>
          					<span class="input-group-addon" id="c2"   >
            					<span class="glyphicon glyphicon-calendar" ></span>
          					</span>
        				</div>
			  
			   <p><p align="left"><input type = "button" class="btn btn-default" id="buscar" value = "Buscar" ng-click="buscar()" >
				<font> &nbsp;  &nbsp;  </font> 
				<input type = "button"class="btn btn-default" id ="cancelar" value = "Cancelar"  ng-click="clear()" >
				<font> &nbsp;  &nbsp;   &nbsp; &nbsp; &nbsp; &nbsp;  </font>
		      <a href="#"  class="text-danger" ng-click="generarReporte()">Generar reporte de Correspondencia
			  </a>
			   </p></p>
            
			</div>
			
         <p align="left"><p align="left"><div id="HTMLtoPDF"    class="table table-bordered" >
		 
		   <IMG SRC="../images/situn2.png" WIDTH=70 HEIGHT=60>
		 <font class="text-danger">Lista de reportes </font>
		   
		   <p><p><table class="table" id="tabla_encabezado" >
	      </table>
		
	<p align="left"><table class="table" id="tabla_busqueda" >

		<thead> 
			<tr class="danger">
			<td>#Oficio</td>
			<td>F.Oficio</td>
			<td>F.Recibido</td>
			<td>Asunto</td>
			<td>Destino</td>
			<td>Copia</td>
			<td>Remitente</td>			
			<td>Estado</td>
			</tr>
		</thead>
		<tbody>
			<tr  ng-repeat = "c in correspondencias">
					<td id="tdid"> {{c.tc_3 }} </td>
					<td> {{c.tc_4 | date:'dd/MM/yyyy'}} </td>
					<td> {{c.tc_2 | date:'dd/MM/yyyy'}} </td>
					<td> {{c.tc_8 }} </td>
					<td> {{c.tc_5 }} </td>
					<td> {{c.tc_6 }} </td>
					<td> {{c.tc_7 }} </td>					
					<td> {{c.tc_10 }} </td>
			</tr>
		</tbody>        
	</table>
	
               </div></p>
      </form>
	  
             
       <div style="margin-top:100px; margin-left:60px; " ><label id="mensaje" class="text-danger"></label></div>
	   </div>
       
	   
	   
	   <script src="\..\javascripts\jspdf.js"></script>


	   
<script type="text/javascript">
  
$(document).ready(function() {
    // Solicita la informacion de la sesion si aun no existe en el storage
	$("#menuDiv").load("/HTML/menu");
		$("#ayuda").click(
	function(){
		$("#miAyuda").show();
	});
	
	$('#f1').val("");
	$('#f2').val("");

});






let app = angular.module('app', []);

function MR_01($scope)//ControllerAngular controller de todos los metodos
 {
	$scope.criterio = "Asunto";
	$scope.correspondencias = new Array();
	$scope.updateCorrespondencias = c => $scope.correspondencias = c;
	$scope.buscar = _ => MR_02($scope);
	$scope.clear = _ => MR_03($scope);
	$scope.generarReporte = _ =>MR_04($scope);

	
	
  }
  
   app.controller('ControllerAngular', MR_01); 
 


  
 function MR_02($scope)  //Metodo de Busqueda , substrae las fechas y las manda como rango de fecha
 {
   
	let fecha1 = $('#f1').val();
	let fecha2 = 	$('#f2').val();
	

	if(MR_05() == true )  {
	
	if(MR_06() == true )  {
	

	$("#tabla_encabezado tr").detach(); //Limpia el encabezado
	
	let table =document.getElementById("tabla_encabezado");
	
    let rowCount = table.rows.length;
    let row = table.insertRow(rowCount);
	
	let cell1 = row.insertCell(0);
	let element1 = document.createTextNode("Desde :");
    cell1.appendChild(element1);
	
    let cell2 = row.insertCell(1);
    let element2 = document.createTextNode(fecha1);
     cell2.appendChild(element2);
   
    let cell3 = row.insertCell(2);
	let element3 = document.createTextNode("Hasta :");
    cell3.appendChild(element3);
	
    let cell4 = row.insertCell(3);
    let element4 = document.createTextNode(fecha2);
     cell4.appendChild(element4);
	

	//Busca las correspondecias segun el rango de fechas
    fetch( 'http://localhost:3000/api/TC/BF', {   //Envia la ruta del servidor (rutas.js) y el sufijo Correspondiente
    method: 'POST',  
    datatype:'json',   
    headers: {  
      "Content-type": "application/x-www-form-urlencoded"  
      } ,
	 body: "TC_4F1=" + fecha1 + "&TC_4F2=" + fecha2
      }
	)	 
	.then(res => res.json())
	.then(obj => $scope.$apply( _=>
	              $scope.updateCorrespondencias(obj.data) )  )
	.catch(err => console.log('Request failed', err));
    
	 
	
		}
	} 

		
 }
 
 
 
 
 
function MR_03($scope){// limpia el div con el id de buscar
    $('#f1').val("");
	$('#f2').val("");
	$scope.correspondencias = new Array();
	$("#tabla_encabezado tr").detach();
	$("#mensaje").text(""); 
} 
	

function MR_04($scope){

let pdf = new jsPDF('p', 'pt', 'letter');
let source =  $('#HTMLtoPDF')[0] ;
specialElementHandlers = {
	'#bypassme': function(element, renderer){
		return true
	}
}
margins = {
    top: 90,
    left: 80,
    width: 545
  };
  
pdf.fromHTML(
    source // El cuerpo del PDF en este caso HTML o string
  	, margins.left // x coordenada x
  	, margins.top // y coordenada y
  	, {
  		'width': margins.width // max width of content on PDF
  		, 'elementHandlers': specialElementHandlers
  	},
  	function (dispose) {
  	  // dispose: object with X, Y of the last line add to the PDF
  	  //          this allow the insertion of new lines after html
        pdf.save('ReporteCorrespondencia.pdf');
      }
  )		
}



$('#datetimepicker1').datetimepicker({
   		format: 'DD-MM-YYYY', 
   		showClear:true,
   		defaultDate: new Date()
	});

$('#datetimepicker2').datetimepicker({
   		format: 'DD-MM-YYYY', 
   		showClear:true,
   		defaultDate: new Date()
	});


function MR_05(){  //Metodo para validar fechas vacias
let A1=true;
let A2=true;
let A3=true;
let A4=true;



let fecha1=$("#f1").val();//Toma el valor del campo de la fecha
let fecha2=$("#f2").val();//Toma el valor del campo de la fecha

if(fecha1.length < 1 || fecha2.length < 1 ){

if(fecha1.length < 1 ){


  
   $("#c1").css( "box-shadow" , " 0px 0px 1px 1px  #540c0c");
    $("#f1").css( "box-shadow" , " 0px 0px 1px 1px  #540c0c");
	$("#f1").attr('title','Campo Obligatorio') ;
	A1=false;
	
	}
	else{
  
     $("#c1").css( "box-shadow" , " 0px 0px 1px 1px  #FFFFFF");
     $("#f1").css( "box-shadow" , " 0px 0px 1px 1px  #FFFFFF");
	 $("#f1").attr('title','') ;
	}
	
	


if(fecha2.length < 1 ){


  
   $("#c2").css( "box-shadow" , " 0px 0px 1px 1px  #540c0c");
    $("#f2").css( "box-shadow" , " 0px 0px 1px 1px  #540c0c");
	$("#f2").attr('title','Campo Obligatorio') ;
	A2=false;
	
	}
	else{
  
     $("#c2").css( "box-shadow" , " 0px 0px 1px 1px  #FFFFFF");
     $("#f2").css( "box-shadow" , " 0px 0px 1px 1px  #FFFFFF");
	 $("#f2").attr('title','') ;
	}
	
	}
	
	
	if( fecha1.length != 0  && fecha2.length != 0  ){
		
		let f1=fecha1.substring(10, 6)+'-'+fecha1.substring(5, 3)+'-'+fecha1.substring(2, 0);
	    let f2=fecha2.substring(10, 6)+'-'+fecha2.substring(5, 3)+'-'+fecha2.substring(2, 0);
		
		if(f1 > f2 ){
         
		  $("#c1").css( "box-shadow" , " 0px 0px 1px 1px  #540c0c");
          $("#f1").css( "box-shadow" , " 0px 0px 1px 1px  #540c0c");
	      $("#f1").attr('title','Fecha Inicial debe ser menor a Fecha Final') ;
		  
		    $("#c2").css( "box-shadow" , " 0px 0px 1px 1px  #540c0c");
          $("#f2").css( "box-shadow" , " 0px 0px 1px 1px  #540c0c");
	      $("#f2").attr('title','Fecha Final debe ser mayor a FechaInicial') ;
		  
		  
		  A3=false;
		 }
		 else {
		$("#c1").css( "box-shadow" , " 0px 0px 1px 1px  #FFFFFF");
        $("#f1").css( "box-shadow" , " 0px 0px 1px 1px  #FFFFFF");
	    $("#f1").attr('title','') ;
		
	    $("#c2").css( "box-shadow" , " 0px 0px 1px 1px  #FFFFFF");
        $("#f2").css( "box-shadow" , " 0px 0px 1px 1px  #FFFFFF");
	    $("#f2").attr('title','') ;
		
		 }
		
		 
		 
		 }
		
		
			return   (  A1 && A2 && A3 ) ; 
}

		
	
function MR_06(){ //Metodo para validar rango de fechas

fetch( 'http://localhost:3000/api/TC/FR', {   //Envia la ruta del servidor (rutas.js) y el sufijo Correspondiente
    method: 'POST',  
    datatype:'json',   
    headers: {  
      "Content-type": "application/x-www-form-urlencoded"  
      } 
      }
	)	 
	.then(res => res.json())
	.then(obj => {
	
		  
     
	 let fecha1 = $('#f1').val();
     let fecha2=obj.data[0].tc_4;

	let fA=fecha1.substring(10, 6)+'-'+fecha1.substring(5, 3)+'-'+fecha1.substring(2, 0);
	
	if(fecha2 < fA ){
	$("#mensaje").text("No hay correspondencias almacenadas que se encuentren en ese rango de fechas"); 
	return false;
    }
	else{
	$("#mensaje").text("");
	}
	
	})
	.catch(err => console.log('Request failed', err));
    

return true;

}

	     
	





	
</script>
	
    </body>
</html>